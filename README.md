# 同志社高等学校 GPA計算機

同志社高等学校の生徒向けに開発された、加重平均計算および学年末評価シミュレーション機能を備えた成績管理ツールです。

## 主な機能

### 1. 加重平均計算機

各学年（1年生・2年生・3年生）の履修科目について、評価（1〜5）を入力することで加重平均を計算します。

- **必修科目**: 全員が履修する科目
- **選択科目**: 2・3年生は規定単位数分の選択科目を選択
- **進級判定**: 進級判定内規に基づく判定結果を表示

#### 進級判定内規

以下のいずれかに該当する場合、進級が困難となる可能性があります：

- **[イ]** 評価1の科目が1科目以上ある
- **[ロ]** 評価2・3の科目が過半数ある
- **[ハ]** 評価2・3の科目が15単位以上ある

### 2. 学年末評価シミュレーター（期間限定機能）

**利用可能期間**: 毎年7月15日〜3月20日

1学期・2学期の成績が確定した後、目標とする学年末加重平均を達成するために必要な3学期の評価をシミュレートする機能です。

#### 評価制度について

同志社高等学校では、以下の評価制度が採用されています：

- **評価範囲**: 10段階評価（1〜10）
- **1学期評価**: 1学期の学習成果（生徒に公開）
- **2学期評価**: 2学期の学習成果（生徒に公開）
- **3学期評価**: 3学期の学習成果（**生徒には非公開**）
- **学年末評価**: 1学期・2学期・3学期の3つの評価の平均を四捨五入した整数値（生徒に公開）

**重要**: 3学期評価は生徒に直接公開されず、1学期・2学期・学年末評価のみが成績として通知されます。

## 学年末評価シミュレーターの計算アルゴリズム

### 概要

このシミュレーターは、以下の入力情報を基に、目標とする学年末加重平均を達成するために各科目で必要な3学期評価を計算します。

**入力情報**:
- 各科目の1学期評価（1〜10）
- 各科目の2学期評価（1〜10）
- 目標とする学年末加重平均（例: 7.5）
- 各科目の重要度（高・通常・低）
- 特定科目の3学期目標評価（任意設定）

**出力情報**:
- 各科目で必要な3学期評価
- 予測される学年末評価（科目ごと）
- 予測される学年末加重平均
- 目標達成可能性の判定
- 注意事項とアドバイス

### 計算手順

#### ステップ1: 学年末評価の計算式

学年末評価は、以下の式で計算されます：

```
学年末評価 = round((1学期評価 + 2学期評価 + 3学期評価) / 3)
```

ここで、`round()`は四捨五入を表します。

例：
- 1学期=7, 2学期=7, 3学期=9 → 学年末評価 = round((7+7+9)/3) = round(7.67) = 8
- 1学期=7, 2学期=8, 3学期=9 → 学年末評価 = round((7+8+9)/3) = round(8.0) = 8

#### ステップ2: 加重平均の計算

加重平均は、各科目の学年末評価と単位数を使って計算されます：

```
加重平均 = Σ(科目の学年末評価 × 単位数) / Σ(単位数)
```

例（2科目の場合）：
- 科目A: 学年末評価7, 単位数3 → 7 × 3 = 21
- 科目B: 学年末評価9, 単位数2 → 9 × 2 = 18
- 加重平均 = (21 + 18) / (3 + 2) = 39 / 5 = 7.8

#### ステップ3: 3学期評価の最適化計算

目標加重平均から、必要な3学期評価を以下のアルゴリズムで計算します：

##### 3.1 目標が設定されている科目の処理

- ユーザーが「この科目は3学期で評価5を取りたい」など、特定の目標を設定している場合
- その目標評価を使用し、学年末評価を確定
- その科目の加重貢献（学年末評価 × 単位数）を計算

##### 3.2 目標が未設定の科目の処理

目標が未設定の科目について、以下の手順で3学期必要評価を計算します：

**a) 必要な加重合計の算出**

```
目標加重合計 = 目標加重平均 × 総単位数
必要な残り加重合計 = 目標加重合計 - (3学期目標設定済み科目の加重合計)
未設定科目の総単位数 = 総単位数 - 3学期目標設定済み科目の単位数
必要な平均学年末評価 = 必要な残り加重合計 / 未設定科目の総単位数
```

**b) 重要度による調整**

科目の重要度に応じて、目標学年末評価を調整します：

```
- 重要度「高」: 調整係数 = 1.1 (目標の110%、より高い評価を狙う)
- 重要度「通常」: 調整係数 = 1.0 (そのまま)
- 重要度「低」: 調整係数 = 0.9 (目標の90%、他科目を優先)

調整後目標学年末評価 = 必要な平均学年末評価 × 調整係数
```

この調整により、「得意科目」「苦手科目」を考慮した現実的な計画が立てられます。

**c) 3学期評価の逆算（最適化探索）**

学年末評価の計算には四捨五入が含まれるため、単純な逆算では正確な値が得られません。
そのため、1〜5のすべての3学期評価候補を試行し、最も目標に近い学年末評価を実現する値を選択します：

```python
def find_optimal_term3(term1, term2, target_year_end):
    best_term3 = 10
    best_diff = infinity
    
    for term3 in range(1, 11):  # 1から10まで試行
        year_end = round((term1 + term2 + term3) / 3)
        diff = abs(year_end - target_year_end)
        
        if diff < best_diff:
            best_diff = diff
            best_term3 = term3
    
    return best_term3
```

例：
- 1学期=4, 2学期=4, 目標学年末=5の場合
  - 3学期=5 → round((4+4+5)/3) = round(4.33) = 4 (差=1)
  - 3学期=5でも学年末5は達成できない → 警告を表示

#### ステップ4: 実現可能性の検証

計算された3学期評価について、以下をチェックします：

**a) 評価範囲チェック**
```
if 3学期必要評価 > 10:
    警告: 「評価10でも目標達成困難」
    3学期必要評価 = 10に固定
    
if 3学期必要評価 < 1:
    3学期必要評価 = 1に固定
```

**b) 成績変動チェック**
```
1・2学期平均 = (1学期評価 + 2学期評価) / 2
成績変動 = 3学期必要評価 - 1・2学期平均

if 成績変動 > 1.5:
    アドバイス: 「大幅な成績向上が必要」
    
if 成績変動 < -1.5:
    アドバイス: 「成績維持で余裕あり」
```

**c) 全体達成可能性の判定**
```
予測加重平均 = Σ(予測学年末評価 × 単位数) / Σ(単位数)

if |予測加重平均 - 目標加重平均| < 0.1:
    判定: 達成可能
else:
    判定: 困難（調整が必要）
```

### 計算例

#### 例1: 2科目の簡単なケース

**入力**:
- 科目A（3単位）: 1学期=7, 2学期=7, 重要度=通常
- 科目B（2単位）: 1学期=6, 2学期=6, 重要度=通常
- 目標加重平均 = 7.5

**計算**:
1. 総単位数 = 3 + 2 = 5
2. 目標加重合計 = 7.5 × 5 = 37.5
3. 必要平均学年末評価 = 37.5 / 5 = 7.5

科目A:
- 調整後目標 = 7.5 × 1.0 = 7.5
- 3学期候補探索:
  - 3学期=7 → 学年末=round((7+7+7)/3)=7 (差=0.5)
  - 3学期=8 → 学年末=round((7+7+8)/3)=7 (差=0.5)
  - 3学期=9 → 学年末=round((7+7+9)/3)=8 (差=0.5)
- 最適3学期評価 = 8
- 予測学年末 = 8

科目B:
- 調整後目標 = 7.5 × 1.0 = 7.5
- 3学期候補探索:
  - 3学期=9 → 学年末=round((6+6+9)/3)=7 (差=0.5)
- 最適3学期評価 = 9
- 予測学年末 = 7

予測加重平均 = (8×3 + 7×2) / 5 = 38 / 5 = 7.6
目標7.5との差 = 0.1 → 「目標達成可能」

#### 例2: 重要度を考慮したケース

**入力**:
- 科目A（3単位）: 1学期=6, 2学期=7, 重要度=高（得意科目）
- 科目B（2単位）: 1学期=6, 2学期=6, 重要度=低（苦手科目）
- 目標加重平均 = 7.0

**計算**:
1. 目標加重合計 = 7.0 × 5 = 35
2. 必要平均学年末評価 = 35 / 5 = 7.0

科目A（重要度:高）:
- 調整後目標 = 7.0 × 1.1 = 7.7
- 3学期候補探索 → 3学期=8
- 予測学年末 = round((6+7+8)/3) = 7

科目B（重要度:低）:
- 調整後目標 = 7.0 × 0.9 = 6.3
- 3学期候補探索 → 3学期=7
- 予測学年末 = round((6+6+7)/3) = 6

予測加重平均 = (7×3 + 6×2) / 5 = 33 / 5 = 6.6
→ 目標7.0には届かないため、再調整を推奨

### アルゴリズムの特徴

#### 利点

1. **四捨五入を考慮**: 学年末評価の四捨五入処理を正確に反映
2. **重要度による最適化**: 得意科目・苦手科目を考慮した現実的な計画
3. **柔軟な目標設定**: 特定科目の目標を固定し、他科目で調整可能
4. **実現可能性の判定**: 無理な目標設定を警告

#### 制約

1. **局所最適解**: 全科目を同時最適化せず、個別最適化を行うため、真の最適解ではない可能性
2. **整数制約**: 評価が1〜10の整数値であるため、目標加重平均によっては完全一致が不可能
3. **予測の不確実性**: 実際の3学期成績は学習努力に依存

### 将来の改善案

- **遺伝的アルゴリズム**: 全科目を同時に最適化する高度な計算手法の導入
- **機械学習**: 過去の成績傾向から3学期成績を予測
- **進級判定統合**: シミュレーション結果が進級条件を満たすかチェック

## 技術スタック

- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **UIコンポーネント**: shadcn/ui
- **状態管理**: React Hooks + LocalStorage

## 開発・実行

```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev

# ビルド
npm run build

# 本番サーバーの起動
npm start
```

## データ構造

### curriculum.json

各学年の科目情報を定義：

```json
{
  "Grades": {
    "1st_Year": {
      "Subjects": [
        {
          "Subject": "科目名",
          "Category": "カテゴリ",
          "Credits": 単位数,
          "Required": true/false,
          "CannotTakeWith": ["同時履修不可科目"]
        }
      ]
    }
  }
}
```

### ローカルストレージ

以下のデータがブラウザのローカルストレージに保存されます：

- `weighted-avg-calc-active-tab`: 現在選択中のタブ（学年）
- `weighted-avg-calc-selected-electives`: 選択科目の情報
- `weighted-avg-calc-scores`: 入力された評価
- `year-end-sim_[tabId]`: シミュレーターの入力データ
- `year-end-sim_[tabId]_target`: 目標加重平均

## ライセンス

© 2024-2025 Kanata Tsuda. All rights reserved.

## 免責事項

このツールは非公式であり、計算結果はあくまで参考値です。正式な成績や進級判定については、学校からの通知を確認してください。
